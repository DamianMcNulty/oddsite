{% import "utility.macros.j2" as utility %}


{% macro section(bird, oss, posts=none) %}
  <div data-module='bird' class="h-card" id="bird-{{ bird.author }}">
    {{ utility.icon(bird.author, size='face') }}

    <header>
      {{ title(bird.name, bird.author, bird.no_posts) }}
      {{ link_list(bird.links[0]) }}
    </header>

    <p>{{ bird.bio|safe }}</p>

    {{ oss_list(bird.author, oss) }}
    {{ publication_list(bird.publications) }}
    {{ blog_list(posts) }}
  </div>
{% endmacro %}


{% macro card(bird, details=false) %}
  {% set bird_title = utility.link_if(bird.name, link_to('author', author=bird.author), class='u-url') %}

  {% if details %}
    {% set short = bird.short if bird.short else bird.bio|truncate(200) %}

    <div class="h-card">
      {{ utility.icon(bird.author, size='face') }}

      <p>
        {{ bird_title }}
        {{ short }}
      </p>

      <ul class="socials">
        {% for link in bird.links[0] %}
          {% if link in ['twitter', 'github'] %}
            {{ get_link(link, bird.links[0][link]) }}
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <span class="h-card">
      {{ bird_title }}
    </span>
  {% endif %}
{% endmacro %}


{% macro get_card(author, config, details=false) %}
  {% set bird_list = config.birds|selectattr('author', 'equalto', author)|list %}
  {% set bird = bird_list[0] %}
  {{ card(bird, details=details) }}
{% endmacro %}


{% macro title(name, author, no_posts=none) %}
  <h2>
    {% if no_posts %}
      {{ name }}
    {% else %}
      <a href="{{ link_to('author', author=author) }}" class="u-url">
        {{ name }}
      </a>
    {% endif %}
  </h2>
{% endmacro %}


{% macro link_list(links) %}
  {% if links %}
  <div class="what-is-this">
    {% for link in links %}
      {{ get_link(link, links[link]) }}
    {% endfor %}
  </div>
  {% endif %}
{% endmacro %}


{% macro get_link(name, user) %}
  {% set locations = {
    'twitter': 'https://twitter.com/%s/',
    'github': 'https://github.com/%s/',
    'lanyrd': 'https://lanyrd.com/profile/%s/',
    'stackoverflow': 'https://stackoverflow.com/users/%s/',
    'dribbble': 'https://dribbble.com/%s/',
    'codepen': 'https://codepen.io/%s/'
  } %}

  {% set displays = {
    'twitter': '@%s',
    'github': '%s',
    'dribbble': '%s'
  } %}

  {% set url = locations[name]|format(user) if locations[name] else none %}
  {% set username = displays[name]|format(user) if displays[name] else name %}

  <a href="{{ url }}" rel="me">
    {{ utility.icon(name) }}
    <span class="icon-text">{{ username or user }}</span>
  </a>
{% endmacro %}


{% macro list_wrapper(title, slug, list) %}
  {% if list %}
    <div>
      <h3>{{ title }}</h3>
      <ul>
        {{ caller() }}
      </ul>
    </div>
  {% endif %}
{% endmacro %}


{% macro list_item(name, url, extra=none) %}
  <li>
    {{ utility.link_if(name, url) }}
    {% if extra %}
      [{{ extra }}]
    {% endif %}
  </li>
{% endmacro %}


{% macro blog_list(posts) %}
  {% call list_wrapper('Blog Posts', 'blog', posts) %}
    {% for entry in posts %}
      {% if loop.index < 4 %}
        {{ list_item(
          name=entry.title,
          url=link_to('page', slug=entry.slug)
        ) }}
      {% endif %}
    {% endfor %}
  {% endcall %}
{% endmacro %}


{% macro publication_list(publications) %}
  {% call list_wrapper('Publications', 'publications', publications) %}
    {% for item in publications %}
      {{ list_item(item.name, item.url) }}
    {% endfor %}
  {% endcall %}
{% endmacro %}


{% macro oss_list(author, oss) %}
  {% call list_wrapper('Open-Source', 'oss', oss) %}
    {% for item in oss %}
      {% set oss_author = item.who|selectattr('author', 'equalto', author)|list %}

      {% if oss_author|length > 0 %}
        {% set oss_author = oss_author[0] %}

        {{ list_item(item.name, item.url or item.source, oss_author.role) }}
      {% endif %}
    {% endfor %}
  {% endcall %}
{% endmacro %}
