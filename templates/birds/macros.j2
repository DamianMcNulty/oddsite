{% import "utility.macros.j2" as utility %}
{% import "content.macros.j2" as content %}
{% import "blog/utility.macros.j2" as blog %}
{% import "birds/utility.macros.j2" as birds %}
{% import "community/events.macros.j2" as events %}


{% macro details(page) %}
  {% set author = page.config.bird %}
  {{ feature_talks(author) }}
  {{ events.by_author(author) }}
  {{ oss_list(author, page) }}
{% endmacro %}


{% macro list(author=none, page=none) %}
  {% set page = page or all_pages|filter_pages('bird', 'eq', author)|get_page %}
  {% set author = author or page.config.bird %}

  <article data-module="bird" class="h-card" id="bird-{{ author }}">
    {{ content.divider(title=birds.name_link(author, page)) }}

    {% call content.media_block(
      media=birds.face(author)
    ) %}
      {{ birds.social_list(
        data=page.config.social,
        bird_name=author|capitalize
        ) }}
    {% endcall %}

    <div class="bio">
      {{ page.render_summary() }}
    </div>

    {{ content.link_button(
      url=birds.get_bird_url(author, page),
      content="See %s's activity" % author|capitalize
      ) }}
  </article>
{% endmacro %}


{% macro feature_talks(author=none) %}
  {% set talks = all_pages|filter_pages('speakers')|filter_pages('brag') %}
  {% set talks = talks|filter_pages('speakers', 'has', author) if author else talks %}

  {% if talks|length %}
    <section class="splash-talks">
      {{ content.divider(title='Featured Talks & Workshops') }}
      <div class="splash-section">
        {% for talk in talks %}
          <article class="splash-talk">
            <h3 class="splash-title">
              {{ utility.link_if(
                url=content.page_link(talk),
                content=talk.title|typogrify
                ) }}
            </h3>
            <div class="splash-brag">
              {% set brag = talk.config.brag %}
              {% set brag = talk.render_summary() if (brag == 'summary') else brag|rst %}
              {{ brag }}
            </div>
          </article>
        {% endfor %}
      </div>
    </section>
  {% endif %}
{% endmacro %}


{% macro blog_list(posts) %}
  {% if posts|length %}
    <div class="bird-posts">
      <h3>Recent Articles</h3>
      <ul class="title-list">
        {% for post in posts %}
          {% if loop.index < 4 %}
            <li>
              {{ blog.link(post) }}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endmacro %}


{% macro oss_list(author, page) %}
  {% set oss = page.config.oss_by_author[author] %}
  {% set oss = oss|filter_pages('public', 'neq', false) %}

  {% if oss and (oss|length > 0) %}
    <section data-module="contributions">
      {{ content.divider(title='Open Source Contributions') }}
      <ul class="title-list">
        {% for item in oss %}
          {% set project = item.config.project[0] %}
          {% set contrib = item.config.contributors|selectattr('author', 'equalto', author)|list %}
          <li>
            {{ utility.link_if(
              project.name or item.title,
              content.project_link(item, allow_external=true)
              ) }}
            [{{ contrib[0].role }}]
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endmacro %}
