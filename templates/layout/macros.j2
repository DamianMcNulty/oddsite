{% import 'utility.macros.j2' as utility %}
{% import 'birds/utility.macros.j2' as birds %}


{% macro tags(taglist) %}
  {% if taglist %}
    <nav class="tags">
      {{ utility.icon('tags', class='icon-tag') }}
      {% for tag in taglist|sort(case_sensitive=true) %}
        <a href="{{ link_to('tag', tag=tag) }}" class="tag" rel="tag">{{ tag }}</a>
      {%- endfor %}
    </nav>
  {% endif %}
{% endmacro %}


{% macro header_image(post) %}
  {% set image = post.config.image[0].src if post.config.image else none %}

  {% if image %}
    <figure class="hero">
      {% if '://' in image %}
        <img src="{{ image }}" class="hero-image">
      {% else %}
        <img src="/static/images/blog/{{ image }}" class="hero-image">
      {% endif %}
    </figure>
  {% endif %}
{% endmacro %}


{% macro show_headline(main, sub=none, type=none) %}
  <h1 class="title">
    {% if type %}
      <div class="title-post-type">{{ type }}</div>
    {% endif %}

    <div class="title-main">{{ main }}</div>

    {% if sub %}
      <em class="title-sub">{{ sub }}</em>
    {% endif %}
  </h1>
{% endmacro %}


{% macro header(rst, ctx) %}
  {% set headline = ctx.config.headline[0] if ctx.config.headline else none %}
  {% set project = ctx.config.project[0] if ctx.config.project else none %}
  {% set client = ctx.config.client[0] if ctx.config.client else none %}
  {% set contributors = ctx.config.contributors if ctx.config.contributors else none %}

  {% set main = headline.title if (headline and headline.title) else none %}
  {% set main = project.name if (project and project.name and not main) else main %}
  {% set main = main or rst.title %}

  {% set sub = headline.tagline if (headline and headline.tagline) else none %}
  {% set sub = project.tagline if (project and project.tagline and not sub) else sub %}

  {% set type = headline.type if (headline and headline.type) else none %}
  {% set type = 'case study' if (project and client and not type) else type %}
  {% set type = 'open-source software' if (project and contributors and not type) else type %}

  {{ header_image(ctx) }}
  {{ show_headline(main, sub, type) }}

  <div class="rst-meta">
    <div class="rst-data">
      {% if ctx.pub_date %}
        <p class="byline">
          {% if ctx.author %}
            <span class="meta-preposition">by</span> {{ birds.get_card(ctx.author) }}
          {% endif %}
          <span class="meta-preposition">on</span> {{ utility.datetime(ctx.pub_date) }}
        </p>
      {% endif %}

      {{ tags(ctx.tags) }}
    </div>

    {% if project and (project.url or project.source) %}
      <div class="project-links">
        {% if project.url %}
          <a href="{{ project.url }}" class="btn">View Site</a>
        {% endif %}
        {% if project.source %}
          <a href="{{ project.source }}" class="btn">View Source</a>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endmacro %}


