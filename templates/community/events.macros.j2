{% import "utility.macros.j2" as utility %}
{% import "content.macros.j2" as content %}
{% import "layout/macros.j2" as layout %}


{% macro by_author(author=none) %}
  {% set pages = all_pages|filter_pages('speakers', 'has', author) if author else all_pages|filter_pages('speakers') %}
  {% set events = pages|collect('events', label_with='slug')|sort(attribute='date') %}
  {% set future = events|filter_events(past=false)|list %}
  {% set past = events|filter_events(past=true)|reverse|list %}
  {% set highlight = future[0] or past[0] or none %}

  {% if events %}
    <section class="events-by-author">
      {{ content.divider(title='Speaking Schedule') }}

      {{ feature(highlight) }}

      {% if future|length > 1 %}
        {{ list(
          events=future,
          title="Upcoming Appearances"
          ) }}
      {% endif %}

      {% if future or (past|length > 1) %}
        {{ list(
          events=past,
          title="Speaking History",
          slice=5
          ) }}
      {% endif %}
    </section>
  {% endif %}
 {% endmacro %}


{% macro feature(event) %}
  {% if event %}
    <article class="feature-event">
      {% set talk = all_pages|filter_pages('slug', 'eq', event.slug)|get_page %}
      {% set talk_url = content.page_link(talk) %}
      {% set talk_url = talk_url if (talk_url != '/talks/tbd/') else none %}

      <h3 class="event-title">
        {% if talk %}
          {{ utility.link_if(
            content=talk.title|typogrify,
            url=talk_url,
            class='event-talk'
            ) }}
          <span class="meta-preposition">at</span>
        {% endif %}
        {{ utility.link_if(
          content=event.venue,
          url=event.url,
          class='event-venue'
          ) }}
      </h3>

      {{ meta(event) }}

      <div class="event-summary">
        {{ talk.render_summary() }}
      </div>
    </article>
  {% endif %}
{% endmacro %}


{% macro list(events, title, slice=none) %}
  {% if events %}
    <section data-module="events-list">
      <h3 class="events-list-title">{{ title }}</h3>

      {% if slice and (events|length > slice) %}
        <button class="btn small-btn more-events" {{ utility.toggle_button('more-events') }}>
          show all events
        </button>
      {% endif %}

      {% for event in events %}
        {{ item(event) }}

        {% if loop.index == slice %}
          <div {{ utility.toggle_target('more-events') }}>
        {% endif %}
        {% if loop.last and slice %}
          </div>
        {% endif %}
      {% endfor %}
    </section>
  {% endif %}
{% endmacro %}


{% macro item(event) %}
  {% set event_date = event.date|make_date %}
  {% set talk = all_pages|filter_pages('slug', 'eq', event.slug)|get_page %}
  {% set talk_url = content.page_link(talk) %}

  <article class="event">
    <h4 class="event-venue">
      {{ utility.link_if(
        content=event.venue,
        url=talk_url
        )  }}
    </h4>

    {{ meta(event) }}
  </article>
{% endmacro %}


{% macro meta(event) %}
  {% set event_date = event.date|make_date %}

  <div class="event-meta">
    <span class="meta-preposition">on</span>
    <time datetime="{{ event_date }}">
      {{ event_date|format_date('%B %-d, %Y') }}
    </time>
    {% if event.adr %}
      <span class="meta-preposition">in</span>
      <span class="adr">{{ event.adr }}</span>
    {% endif %}
  </div>
{% endmacro %}
