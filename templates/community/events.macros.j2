{% import "utility.macros.j2" as utility %}
{% import "content.macros.j2" as content %}
{% import "layout/macros.j2" as layout %}


{% macro by_author(author=none) %}
  {% set pages = all_pages|filter_pages('speakers', 'has', author) if author else all_pages|filter_pages('speakers') %}
  {% set events = pages|collect('events', label_with='slug')|sort(attribute='date') %}
  {% set future = events|filter_events(past=false)|list %}
  {% set past = events|filter_events(past=true)|reverse|list %}
  {% set highlight = future[0] or past[0] or none %}

  {% if events %}
    <section class="events-by-author">
      {{ content.divider(title='Speaking Schedule') }}

      {% if highlight %}
        {{ feature(highlight) }}
      {% endif %}

      {% if (future|length > 1) %}
        <section data-module="future-events">
          <h3>Upcoming Talks</h3>
          {% for event in future %}
            {{ '' if loop.first else list(event) }}
          {% endfor %}
        </section>
      {% endif %}

      {% if past %}
        <section data-module="past-events">
          <h3>Past Talks</h3>
          {% for event in past %}
            {% set skip = loop.first and not future.first %}
            {{ '' if skip else list(event, talk=false) }}
          {% endfor %}
        </section>
      {% endif %}
    </section>
  {% endif %}
 {% endmacro %}


{% macro feature(event) %}
  <article class="feature-event">
    {% set talk = all_pages|filter_pages('slug', 'eq', event.slug)|get_page %}
    {% set images = event.image or talk.config.image %}
    {% set image = layout.get_image(images, 'thumbnail', 'event-image') %}
    {% set head = feature_head(event, talk) %}

    {% if image %}
      {{ content.media_block(image, head) }}
    {% else %}
      {{ head }}
    {% endif %}

    {{ meta(event) }}

    <div class="event-summary">
      {{ talk.render_summary() }}
    </div>
  </article>
{% endmacro %}


{% macro feature_head(event, talk) %}
  {% set talk_url = content.page_link(talk) %}

  <h3 class="event-venue">
    {{ utility.link_if(
      content=event.venue,
      url=event.url
      ) }}
  </h3>

  {{ utility.link_if(
    content=talk.title|typogrify,
    url=talk_url,
    class='event-talk'
    )  }}
{% endmacro %}


{% macro list(event, talk=true) %}
  {% set event_date = event.date|make_date %}

  <article class="event">
    <h4 class="event-venue">

      {% if '://' in event.url %}
        {{ event.venue }}
        {{ utility.link_if(
          content=utility.icon('external', size='text-small'),
          url=event.url,
          class='icon-link'
          )  }}
      {% else %}
        {{ utility.link_if(
          content=event.venue,
          url=event.url
          )  }}
      {% endif %}
    </h4>

    {% if talk %}
      {% set talk = all_pages|filter_pages('slug', 'eq', event.slug)|get_page %}
      {{ utility.link_if(
        content=talk.title|typogrify,
        url=content.page_link(talk),
        class='event-talk'
        )  }}
    {% endif %}

    {{ meta(event) }}
  </article>
{% endmacro %}


{% macro meta(event) %}
  {% set event_date = event.date|make_date %}

  <div class="event-meta">
    <span class="meta-preposition">on</span>
    <time datetime="{{ event_date }}">
      {{ event_date|format_date('%B %-d, %Y') }}
    </time>
    <span class="meta-preposition">in</span>
    <span class="adr">{{ event.adr }}</span>
  </div>
{% endmacro %}
